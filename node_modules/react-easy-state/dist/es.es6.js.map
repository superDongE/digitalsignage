{"version":3,"file":"es.es6.js","sources":["../src/utils.js","../src/view.js","../src/store.js","../src/scheduler.js"],"sourcesContent":["import { useState } from 'react'\n\n// try to find the global object\n// it is window in the DOM and global in NodeJS and React Native\nconst isDOM = typeof window !== 'undefined'\nconst isNative = typeof global !== 'undefined'\nexport const globalObj = isDOM ? window : isNative ? global : undefined\n\nexport const hasHooks = typeof useState === 'function'\n","import { Component, useState, useEffect, useMemo, memo } from 'react'\nimport { observe, unobserve, raw, isObservable } from '@nx-js/observer-util'\nimport { hasHooks } from './utils'\n\nexport let isInsideFunctionComponent = false\nconst COMPONENT = Symbol('owner component')\n\nexport default function view (Comp) {\n  const isStatelessComp = !(Comp.prototype && Comp.prototype.isReactComponent)\n\n  let ReactiveComp\n\n  if (isStatelessComp && hasHooks) {\n    // use a hook based reactive wrapper when we can\n    ReactiveComp = memo(props => {\n      // use a dummy setState to update the component\n      const [, setState] = useState()\n\n      // create a memoized reactive wrapper of the original component (render)\n      // at the very first run of the component function\n      const render = useMemo(\n        () =>\n          observe(Comp, {\n            scheduler: () => setState({}),\n            lazy: true\n          }),\n        // Adding the original Comp here is necessary to make React Hot Reload work\n        // it does not affect behavior otherwise\n        [Comp]\n      )\n\n      // cleanup the reactive connections after the very last render of the component\n      useEffect(() => {\n        return () => unobserve(render)\n      }, [])\n\n      // the isInsideFunctionComponent flag is used to toggle `store` behavior\n      // based on where it was called from\n      isInsideFunctionComponent = true\n      try {\n        // run the reactive render instead of the original one\n        return render(props)\n      } finally {\n        isInsideFunctionComponent = false\n      }\n    })\n  } else {\n    const BaseComp = isStatelessComp ? Component : Comp\n    // a HOC which overwrites render, shouldComponentUpdate and componentWillUnmount\n    // it decides when to run the new reactive methods and when to proxy to the original methods\n    class ReactiveClassComp extends BaseComp {\n      constructor (props, context) {\n        super(props, context)\n\n        this.state = this.state || {}\n        this.state[COMPONENT] = this\n\n        // create a reactive render for the component\n        this.render = observe(this.render, {\n          scheduler: () => this.setState({}),\n          lazy: true\n        })\n      }\n\n      render () {\n        return isStatelessComp\n          ? Comp(this.props, this.context)\n          : super.render()\n      }\n\n      // react should trigger updates on prop changes, while easyState handles store changes\n      shouldComponentUpdate (nextProps, nextState) {\n        const { props, state } = this\n\n        // respect the case when the user defines a shouldComponentUpdate\n        if (super.shouldComponentUpdate) {\n          return super.shouldComponentUpdate(nextProps, nextState)\n        }\n\n        // return true if it is a reactive render or state changes\n        if (state !== nextState) {\n          return true\n        }\n\n        // the component should update if any of its props shallowly changed value\n        const keys = Object.keys(props)\n        const nextKeys = Object.keys(nextProps)\n        return (\n          nextKeys.length !== keys.length ||\n          nextKeys.some(key => props[key] !== nextProps[key])\n        )\n      }\n\n      // add a custom deriveStoresFromProps lifecyle method\n      static getDerivedStateFromProps (props, state) {\n        if (super.deriveStoresFromProps) {\n          // inject all local stores and let the user mutate them directly\n          const stores = mapStateToStores(state)\n          super.deriveStoresFromProps(props, ...stores)\n        }\n        // respect user defined getDerivedStateFromProps\n        if (super.getDerivedStateFromProps) {\n          return super.getDerivedStateFromProps(props, state)\n        }\n        return null\n      }\n\n      componentWillUnmount () {\n        // call user defined componentWillUnmount\n        if (super.componentWillUnmount) {\n          super.componentWillUnmount()\n        }\n        // clean up memory used by Easy State\n        unobserve(this.render)\n      }\n    }\n\n    ReactiveComp = ReactiveClassComp\n  }\n\n  ReactiveComp.displayName = Comp.displayName || Comp.name\n  // static props are inherited by class components,\n  // but have to be copied for function components\n  if (isStatelessComp) {\n    for (let key of Object.keys(Comp)) {\n      ReactiveComp[key] = Comp[key]\n    }\n  }\n\n  return ReactiveComp\n}\n\nfunction mapStateToStores (state) {\n  // find store properties and map them to their none observable raw value\n  // to do not trigger none static this.setState calls\n  // from the static getDerivedStateFromProps lifecycle method\n  const component = state[COMPONENT]\n  return Object.keys(component)\n    .map(key => component[key])\n    .filter(isObservable)\n    .map(raw)\n}\n","import { useMemo } from 'react'\nimport { observable } from '@nx-js/observer-util'\nimport { isInsideFunctionComponent } from './view'\nimport { hasHooks } from './utils'\n\nexport default function store (obj) {\n  // do not create new versions of the store on every render\n  // if it is a local store in a function component\n  // create a memoized store at the first call instead\n  if (hasHooks && isInsideFunctionComponent) {\n    return useMemo(() => observable(obj), [])\n  }\n  return observable(obj)\n}\n","/* eslint camelcase: 0 */\n\n// react platform is set to either react-dom or react-native during test and execution\nimport { unstable_batchedUpdates } from 'react-platform'\nimport { globalObj } from './utils'\n\n// this runs the passed function and delays all re-renders\n// until the function is finished running\nexport function batch (fn, ctx, args) {\n  let result\n  unstable_batchedUpdates(() => (result = fn.apply(ctx, args)))\n  return result\n}\n\n// this creates and returns a batched version of the passed function\n// the cache is necessary to always map the same thing to the same function\n// which makes sure that addEventListener/removeEventListener pairs don't break\nconst cache = new WeakMap()\nfunction batchFn (fn) {\n  if (typeof fn !== 'function') {\n    return fn\n  }\n  let batched = cache.get(fn)\n  if (!batched) {\n    batched = function (...args) {\n      return batch(fn, this, args)\n    }\n    cache.set(fn, batched)\n  }\n  return batched\n}\n\n// batched obj.addEventListener(cb) like callbacks\nfunction batchMethodsCallbacks (obj, methods) {\n  methods.forEach(method => batchMethodCallbacks(obj, method))\n}\n\nfunction batchMethodCallbacks (obj, method) {\n  const descriptor = Object.getOwnPropertyDescriptor(obj, method)\n  if (\n    descriptor &&\n    descriptor.writable &&\n    typeof descriptor.value === 'function'\n  ) {\n    obj[method] = new Proxy(descriptor.value, {\n      apply (target, ctx, args) {\n        return Reflect.apply(target, ctx, args.map(batchFn))\n      }\n    })\n  }\n}\n\n// batches obj.onevent = fn like calls\nfunction batchMethods (obj, methods) {\n  methods.forEach(method => batchMethod(obj, method))\n}\n\nfunction batchMethod (obj, method) {\n  const descriptor = Object.getOwnPropertyDescriptor(obj, method)\n  if (descriptor && descriptor.configurable) {\n    const newDescriptor = Object.assign({}, descriptor, {\n      set (value) {\n        return descriptor.set.call(this, batchFn(value))\n      }\n    })\n    Object.defineProperty(obj, method, newDescriptor)\n  }\n}\n\n// do a sync batching for the most common task sources\n// this should be removed when React's own batching is improved in the future\n\n// batch timer functions\nbatchMethodsCallbacks(globalObj, [\n  'setTimeout',\n  'setInterval',\n  'requestAnimationFrame',\n  'requestIdleCallback'\n])\n\nif (globalObj.Promise) {\n  batchMethodsCallbacks(Promise.prototype, ['then', 'catch'])\n}\n\n// batch addEventListener calls\nif (globalObj.EventTarget) {\n  batchMethodsCallbacks(EventTarget.prototype, [\n    'addEventListener',\n    'removeEventListener'\n  ])\n}\n\n// this batches websocket event handlers\nif (globalObj.WebSocket) {\n  batchMethods(WebSocket.prototype, [\n    'onopen',\n    'onmessage',\n    'onerror',\n    'onclose'\n  ])\n}\n\n// HTTP event handlers are usually wrapped by Promises, which is covered above\n"],"names":["isDOM","window","isNative","global","globalObj","undefined","hasHooks","useState","isInsideFunctionComponent","COMPONENT","Symbol","view","Comp","isStatelessComp","prototype","isReactComponent","ReactiveComp","memo","props","setState","render","useMemo","observe","scheduler","lazy","useEffect","unobserve","BaseComp","Component","ReactiveClassComp","constructor","context","state","shouldComponentUpdate","nextProps","nextState","keys","Object","nextKeys","length","some","key","getDerivedStateFromProps","deriveStoresFromProps","stores","mapStateToStores","componentWillUnmount","displayName","name","component","map","filter","isObservable","raw","store","obj","observable","batch","fn","ctx","args","result","unstable_batchedUpdates","apply","cache","WeakMap","batchFn","batched","get","set","batchMethodsCallbacks","methods","forEach","method","batchMethodCallbacks","descriptor","getOwnPropertyDescriptor","writable","value","Proxy","target","Reflect","batchMethods","batchMethod","configurable","newDescriptor","assign","call","defineProperty","Promise","EventTarget","WebSocket"],"mappings":"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"}