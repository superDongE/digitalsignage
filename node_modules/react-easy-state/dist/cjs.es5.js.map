{"version":3,"file":"cjs.es5.js","sources":["../src/utils.js","../src/view.js","../src/store.js","../src/scheduler.js"],"sourcesContent":["import { useState } from 'react'\n\n// try to find the global object\n// it is window in the DOM and global in NodeJS and React Native\nconst isDOM = typeof window !== 'undefined'\nconst isNative = typeof global !== 'undefined'\nexport const globalObj = isDOM ? window : isNative ? global : undefined\n\nexport const hasHooks = typeof useState === 'function'\n","import { Component, useState, useEffect, useMemo, memo } from 'react'\nimport { observe, unobserve, raw, isObservable } from '@nx-js/observer-util'\nimport { hasHooks } from './utils'\n\nexport let isInsideFunctionComponent = false\nconst COMPONENT = Symbol('owner component')\n\nexport default function view (Comp) {\n  const isStatelessComp = !(Comp.prototype && Comp.prototype.isReactComponent)\n\n  let ReactiveComp\n\n  if (isStatelessComp && hasHooks) {\n    // use a hook based reactive wrapper when we can\n    ReactiveComp = memo(props => {\n      // use a dummy setState to update the component\n      const [, setState] = useState()\n\n      // create a memoized reactive wrapper of the original component (render)\n      // at the very first run of the component function\n      const render = useMemo(\n        () =>\n          observe(Comp, {\n            scheduler: () => setState({}),\n            lazy: true\n          }),\n        // Adding the original Comp here is necessary to make React Hot Reload work\n        // it does not affect behavior otherwise\n        [Comp]\n      )\n\n      // cleanup the reactive connections after the very last render of the component\n      useEffect(() => {\n        return () => unobserve(render)\n      }, [])\n\n      // the isInsideFunctionComponent flag is used to toggle `store` behavior\n      // based on where it was called from\n      isInsideFunctionComponent = true\n      try {\n        // run the reactive render instead of the original one\n        return render(props)\n      } finally {\n        isInsideFunctionComponent = false\n      }\n    })\n  } else {\n    const BaseComp = isStatelessComp ? Component : Comp\n    // a HOC which overwrites render, shouldComponentUpdate and componentWillUnmount\n    // it decides when to run the new reactive methods and when to proxy to the original methods\n    class ReactiveClassComp extends BaseComp {\n      constructor (props, context) {\n        super(props, context)\n\n        this.state = this.state || {}\n        this.state[COMPONENT] = this\n\n        // create a reactive render for the component\n        this.render = observe(this.render, {\n          scheduler: () => this.setState({}),\n          lazy: true\n        })\n      }\n\n      render () {\n        return isStatelessComp\n          ? Comp(this.props, this.context)\n          : super.render()\n      }\n\n      // react should trigger updates on prop changes, while easyState handles store changes\n      shouldComponentUpdate (nextProps, nextState) {\n        const { props, state } = this\n\n        // respect the case when the user defines a shouldComponentUpdate\n        if (super.shouldComponentUpdate) {\n          return super.shouldComponentUpdate(nextProps, nextState)\n        }\n\n        // return true if it is a reactive render or state changes\n        if (state !== nextState) {\n          return true\n        }\n\n        // the component should update if any of its props shallowly changed value\n        const keys = Object.keys(props)\n        const nextKeys = Object.keys(nextProps)\n        return (\n          nextKeys.length !== keys.length ||\n          nextKeys.some(key => props[key] !== nextProps[key])\n        )\n      }\n\n      // add a custom deriveStoresFromProps lifecyle method\n      static getDerivedStateFromProps (props, state) {\n        if (super.deriveStoresFromProps) {\n          // inject all local stores and let the user mutate them directly\n          const stores = mapStateToStores(state)\n          super.deriveStoresFromProps(props, ...stores)\n        }\n        // respect user defined getDerivedStateFromProps\n        if (super.getDerivedStateFromProps) {\n          return super.getDerivedStateFromProps(props, state)\n        }\n        return null\n      }\n\n      componentWillUnmount () {\n        // call user defined componentWillUnmount\n        if (super.componentWillUnmount) {\n          super.componentWillUnmount()\n        }\n        // clean up memory used by Easy State\n        unobserve(this.render)\n      }\n    }\n\n    ReactiveComp = ReactiveClassComp\n  }\n\n  ReactiveComp.displayName = Comp.displayName || Comp.name\n  // static props are inherited by class components,\n  // but have to be copied for function components\n  if (isStatelessComp) {\n    for (let key of Object.keys(Comp)) {\n      ReactiveComp[key] = Comp[key]\n    }\n  }\n\n  return ReactiveComp\n}\n\nfunction mapStateToStores (state) {\n  // find store properties and map them to their none observable raw value\n  // to do not trigger none static this.setState calls\n  // from the static getDerivedStateFromProps lifecycle method\n  const component = state[COMPONENT]\n  return Object.keys(component)\n    .map(key => component[key])\n    .filter(isObservable)\n    .map(raw)\n}\n","import { useMemo } from 'react'\nimport { observable } from '@nx-js/observer-util'\nimport { isInsideFunctionComponent } from './view'\nimport { hasHooks } from './utils'\n\nexport default function store (obj) {\n  // do not create new versions of the store on every render\n  // if it is a local store in a function component\n  // create a memoized store at the first call instead\n  if (hasHooks && isInsideFunctionComponent) {\n    return useMemo(() => observable(obj), [])\n  }\n  return observable(obj)\n}\n","/* eslint camelcase: 0 */\n\n// react platform is set to either react-dom or react-native during test and execution\nimport { unstable_batchedUpdates } from 'react-platform'\nimport { globalObj } from './utils'\n\n// this runs the passed function and delays all re-renders\n// until the function is finished running\nexport function batch (fn, ctx, args) {\n  let result\n  unstable_batchedUpdates(() => (result = fn.apply(ctx, args)))\n  return result\n}\n\n// this creates and returns a batched version of the passed function\n// the cache is necessary to always map the same thing to the same function\n// which makes sure that addEventListener/removeEventListener pairs don't break\nconst cache = new WeakMap()\nfunction batchFn (fn) {\n  if (typeof fn !== 'function') {\n    return fn\n  }\n  let batched = cache.get(fn)\n  if (!batched) {\n    batched = function (...args) {\n      return batch(fn, this, args)\n    }\n    cache.set(fn, batched)\n  }\n  return batched\n}\n\n// batched obj.addEventListener(cb) like callbacks\nfunction batchMethodsCallbacks (obj, methods) {\n  methods.forEach(method => batchMethodCallbacks(obj, method))\n}\n\nfunction batchMethodCallbacks (obj, method) {\n  const descriptor = Object.getOwnPropertyDescriptor(obj, method)\n  if (\n    descriptor &&\n    descriptor.writable &&\n    typeof descriptor.value === 'function'\n  ) {\n    obj[method] = new Proxy(descriptor.value, {\n      apply (target, ctx, args) {\n        return Reflect.apply(target, ctx, args.map(batchFn))\n      }\n    })\n  }\n}\n\n// batches obj.onevent = fn like calls\nfunction batchMethods (obj, methods) {\n  methods.forEach(method => batchMethod(obj, method))\n}\n\nfunction batchMethod (obj, method) {\n  const descriptor = Object.getOwnPropertyDescriptor(obj, method)\n  if (descriptor && descriptor.configurable) {\n    const newDescriptor = Object.assign({}, descriptor, {\n      set (value) {\n        return descriptor.set.call(this, batchFn(value))\n      }\n    })\n    Object.defineProperty(obj, method, newDescriptor)\n  }\n}\n\n// do a sync batching for the most common task sources\n// this should be removed when React's own batching is improved in the future\n\n// batch timer functions\nbatchMethodsCallbacks(globalObj, [\n  'setTimeout',\n  'setInterval',\n  'requestAnimationFrame',\n  'requestIdleCallback'\n])\n\nif (globalObj.Promise) {\n  batchMethodsCallbacks(Promise.prototype, ['then', 'catch'])\n}\n\n// batch addEventListener calls\nif (globalObj.EventTarget) {\n  batchMethodsCallbacks(EventTarget.prototype, [\n    'addEventListener',\n    'removeEventListener'\n  ])\n}\n\n// this batches websocket event handlers\nif (globalObj.WebSocket) {\n  batchMethods(WebSocket.prototype, [\n    'onopen',\n    'onmessage',\n    'onerror',\n    'onclose'\n  ])\n}\n\n// HTTP event handlers are usually wrapped by Promises, which is covered above\n"],"names":["isDOM","window","isNative","global","globalObj","undefined","hasHooks","useState","isInsideFunctionComponent","COMPONENT","Symbol","view","Comp","isStatelessComp","prototype","isReactComponent","ReactiveComp","memo","props","setState","render","useMemo","observe","scheduler","lazy","useEffect","unobserve","BaseComp","Component","ReactiveClassComp","context","state","nextProps","nextState","keys","Object","nextKeys","length","some","key","stores","mapStateToStores","displayName","name","component","map","filter","isObservable","raw","store","obj","observable","batch","fn","ctx","args","result","unstable_batchedUpdates","apply","cache","WeakMap","batchFn","batched","get","set","batchMethodsCallbacks","methods","forEach","method","batchMethodCallbacks","descriptor","getOwnPropertyDescriptor","writable","value","Proxy","target","Reflect","batchMethods","batchMethod","configurable","newDescriptor","assign","call","defineProperty","Promise","EventTarget","WebSocket"],"mappings":"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"}